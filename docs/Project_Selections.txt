==================================================
1. Port Configuration:
==================================================
| Service             | Port  |
| ------------------- | ----- |
| UI (admin)          | 3000  |
| Agent Service (ADK) | 3000  |
| Backend API         | 5000  |
| Ollama              | 11434 |

URLs:
- http://localhost:3000/admin        â†’ Admin UI
- http://localhost:3000/agent       â†’ Agent Service
- http://localhost:5000/api         â†’ Backend API
- http://localhost:11434            â†’ Ollama

Note: For prototype, Agent Service runs on same port 3000 as UI.

UI calls Agent â†’ Agent calls tools and API.


==================================================
2. Project Structure:
==================================================
ShopAgent/
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ dynamic/
â”‚   â”‚   â”œâ”€â”€ orders.json
â”‚   â”‚   â”œâ”€â”€ products.json
â”‚   â”‚   â”œâ”€â”€ workflow.state.json          # ğŸ§  Runtime state
â”‚   â”‚   â””â”€â”€ sessions.state.json          # ğŸ§  Chat memory
â”‚   â”‚
â”‚   â””â”€â”€ seed/
â”‚       â””â”€â”€ ... (unchanged)
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ COMPLETE_PROJECT_DOCUMENTATION.md
â”‚   â”œâ”€â”€ Project_Selections.txt
â”‚   â”œâ”€â”€ state-model.md                   # ğŸ†•
â”‚   â”œâ”€â”€ observability.md                 # ğŸ†•
â”‚   â””â”€â”€ agent-flow.md                    # ğŸ†•
â”‚
â”œâ”€â”€ public/                              # UI (unchanged)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __tests__/                       # (unchanged)
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                          # REST APIs (unchanged)
â”‚   â”‚   â”œâ”€â”€ orders.ts
â”‚   â”‚   â”œâ”€â”€ products.ts
â”‚   â”‚   â””â”€â”€ promotions.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                           # ğŸ¤– Agent Brain
â”‚   â”‚   â”œâ”€â”€ admin.agent.ts
â”‚   â”‚   â”œâ”€â”€ planner.ts
â”‚   â”‚   â”œâ”€â”€ executor.ts
â”‚   â”‚   â”œâ”€â”€ prompt.builder.ts
â”‚   â”‚   â””â”€â”€ context.manager.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                           # ğŸ”§ PROMPT TOOLS + GUARDS
â”‚   â”‚   â”œâ”€â”€ orders.tool.ts               # read/update + guards
â”‚   â”‚   â”œâ”€â”€ products.tool.ts
â”‚   â”‚   â”œâ”€â”€ promotions.tool.ts
â”‚   â”‚   â”œâ”€â”€ validation.guard.ts          # schema + value checks
â”‚   â”‚   â”œâ”€â”€ price.guard.ts               # outlier detection
â”‚   â”‚   â”œâ”€â”€ transition.guard.ts          # status rules
â”‚   â”‚   â””â”€â”€ human.confirm.guard.ts       # HITL
â”‚   â”‚
â”‚   â”œâ”€â”€ state/                           # ğŸ§  Strong Persistence
â”‚   â”‚   â”œâ”€â”€ state.manager.ts
â”‚   â”‚   â”œâ”€â”€ workflow.store.ts
â”‚   â”‚   â”œâ”€â”€ session.store.ts
â”‚   â”‚   â””â”€â”€ state.types.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ observability/                   # ğŸ“Š Metrics + Tracing
â”‚   â”‚   â”œâ”€â”€ metrics.ts
â”‚   â”‚   â”œâ”€â”€ tracer.ts
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â””â”€â”€ correlation.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/                             # Ollama
â”‚   â”‚   â”œâ”€â”€ ollama.client.ts
â”‚   â”‚   â”œâ”€â”€ token.counter.ts
â”‚   â”‚   â””â”€â”€ model.config.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                           # (unchanged)
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                           # (keep storage + errors)
â”‚   â”‚   â”œâ”€â”€ errors.ts
â”‚   â”‚   â””â”€â”€ storage.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ seed.ts
â”‚   â””â”€â”€ server.ts
â”‚
â”œâ”€â”€ jest.config.js
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json


==================================================
3. Agent Architecture:
==================================================
One ADK agent service with 4 logical agents internally:

ShopAgent (ADK Service)
 â”œâ”€â”€ PlannerAgent
 â”œâ”€â”€ ValidationAgent
 â”œâ”€â”€ ExecutionAgent
 â””â”€â”€ ResponseAgent

==================================================
4. Agent Responsibilities:
==================================================
PlannerAgent:
- Intent detection
- Entity extraction
- Normalize user input

Examples:
"Change price of PD-1067 to $67"
â†’ UPDATE_PRODUCT_PRICE
â†’ sku=PD-1067
â†’ newPrice=67

ValidationAgent:
- Schema validation
- Business rules
- Guardrails
- Risk detection

Examples:
- SKU exists?
- Price >= 0?
- Price deviation threshold?
- Order status transition valid?

ExecutionAgent:
- Calls backend APIs
- Updates JSON data
- Handles atomic writes

ResponseAgent:
- User-friendly messages
- Confirmation prompts
- Error explanations


==================================================
5. Agent Prompts (Concise):
==================================================
PlannerAgent Prompt:
You are a PlannerAgent for an e-commerce admin system. Extract intent and entities from user messages.

Your task:
1. Identify the intent (UPDATE_PRODUCT_PRICE, CANCEL_ORDER, UPDATE_ORDER_STATUS, etc.)
2. Extract entities (sku, orderNumber, price, status, etc.)
3. Return JSON: {"intent": "...", "entities": {...}, "confidence": 0.0-1.0}

Supported intents:
- UPDATE_PRODUCT_PRICE
- UPDATE_PRODUCT_DESCRIPTION
- CANCEL_ORDER
- UPDATE_ORDER_STATUS
- SHOW_PRODUCT_INFO
- SHOW_ORDER_INFO

Example:
Input: "Change price of HP-BLK-001 to $320"
Output: {"intent": "UPDATE_PRODUCT_PRICE", "entities": {"sku": "HP-BLK-001", "newPrice": 320}, "confidence": 0.95}


ValidationAgent Prompt:
You are a ValidationAgent. Validate business rules and detect risks.

Your task:
1. Check if entities exist (SKU, orderNumber)
2. Validate business rules (price >= 0, valid status transitions)
3. Calculate risk flags (PRICE_OUTLIER if deviation > 40%)
4. Return JSON: {"valid": true/false, "riskFlag": "...", "errors": [...]}

Guardrails:
- Price deviation > 40% â†’ PRICE_OUTLIER
- Price < 0 â†’ INVALID_PRICE
- SKU not found â†’ SKU_NOT_FOUND
- Invalid status transition â†’ INVALID_TRANSITION
- Order already shipped â†’ CANNOT_CANCEL_SHIPPED

Example:
Input: {"intent": "UPDATE_PRODUCT_PRICE", "entities": {"sku": "HP-BLK-001", "newPrice": 67}, "oldPrice": 890}
Output: {"valid": false, "riskFlag": "PRICE_OUTLIER", "errors": ["Price deviation 92% exceeds 40% threshold"]}


ExecutionAgent Prompt:
You are an ExecutionAgent. Execute validated actions via API calls.

Your task:
1. Map intent to API endpoint
2. Construct API request payload
3. Call backend API (http://localhost:5000/api)
4. Handle errors and retries
5. Return JSON: {"success": true/false, "data": {...}, "error": "..."}

API Endpoints:
- UPDATE_PRODUCT_PRICE â†’ PUT /api/v1/products/{sku}/price
- CANCEL_ORDER â†’ PUT /api/v1/orders/{orderNumber}/cancel
- UPDATE_ORDER_STATUS â†’ PUT /api/v1/orders/{orderNumber}/status

Example:
Input: {"intent": "UPDATE_PRODUCT_PRICE", "entities": {"sku": "HP-BLK-001", "newPrice": 320}, "confirmed": true}
Output: {"success": true, "data": {"sku": "HP-BLK-001", "oldPrice": 299.99, "newPrice": 320}}


ResponseAgent Prompt:
You are a ResponseAgent. Generate user-friendly responses.

Your task:
1. Format success messages clearly
2. Create confirmation prompts for risky actions
3. Explain errors in plain language
4. Include relevant details (order numbers, SKUs, prices)

Response types:
- Success: "âœ… Successfully updated price of HP-BLK-001 from $299.99 to $320"
- Confirmation needed: "âš ï¸ Large price change detected (92% drop). Please confirm: 'CONFIRM price change for HP-BLK-001 to $67'"
- Error: "âŒ Error: Product SKU-9999 not found. Please check the SKU and try again."

Example:
Input: {"success": true, "intent": "UPDATE_PRODUCT_PRICE", "data": {"sku": "HP-BLK-001", "oldPrice": 299.99, "newPrice": 320}}
Output: "âœ… Successfully updated the price of Premium Wireless Headphones (HP-BLK-001) from $299.99 to $320."


Agent Output Examples:
======================
PlannerAgent Output:
{
  "intent": "UPDATE_PRODUCT_PRICE",
  "entities": {
    "sku": "HP-BLK-001",
    "newPrice": 320
  },
  "confidence": 0.95,
  "timestamp": "2026-01-29T10:11:00.045Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ValidationAgent Output (Success):
{
  "valid": true,
  "riskFlag": null,
  "errors": [],
  "entityExists": true,
  "businessRulesPassed": true,
  "timestamp": "2026-01-29T10:11:00.120Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ValidationAgent Output (Price Outlier):
{
  "valid": false,
  "riskFlag": "PRICE_OUTLIER",
  "errors": ["Price deviation 92% exceeds 40% threshold"],
  "entityExists": true,
  "businessRulesPassed": false,
  "oldPrice": 890,
  "newPrice": 67,
  "deviationPercent": 92.47,
  "requiresConfirmation": true,
  "timestamp": "2026-01-29T10:11:00.120Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ValidationAgent Output (SKU Not Found):
{
  "valid": false,
  "riskFlag": "SKU_NOT_FOUND",
  "errors": ["Product with SKU SKU-9999 not found"],
  "entityExists": false,
  "businessRulesPassed": false,
  "requiresConfirmation": false,
  "timestamp": "2026-01-29T10:11:00.120Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ExecutionAgent Output (Success):
{
  "success": true,
  "data": {
    "sku": "HP-BLK-001",
    "oldPrice": 299.99,
    "newPrice": 320,
    "productName": "Premium Wireless Headphones",
    "updatedAt": "2026-01-29T10:11:00.280Z"
  },
  "error": null,
  "apiResponse": {
    "statusCode": 200,
    "message": "Product price updated successfully"
  },
  "timestamp": "2026-01-29T10:11:00.280Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ExecutionAgent Output (API Error):
{
  "success": false,
  "data": null,
  "error": "API request failed: Product not found",
  "apiResponse": {
    "statusCode": 404,
    "message": "Product with SKU HP-BLK-999 not found"
  },
  "timestamp": "2026-01-29T10:11:00.280Z",
  "traceId": "t-101",
  "workflowId": "SHOP-7788"
}

ResponseAgent Output (Success):
"âœ… Successfully updated the price of Premium Wireless Headphones (HP-BLK-001) from $299.99 to $320."

ResponseAgent Output (Confirmation Needed):
"âš ï¸ This is a large price change (from $890 â†’ $67, 92% drop).

Please confirm:
'CONFIRM price change for HP-BLK-001 to $67'"

ResponseAgent Output (Error):
"âŒ Error: Product SKU-9999 not found. Please check the SKU and try again."

ResponseAgent Output (Order Cancelled):
"âœ… Successfully cancelled order ORD-1001. The order status has been updated to 'cancelled'."

ResponseAgent Output (Invalid Transition):
"âŒ Error: Cannot cancel order ORD-2001. This order has already been shipped and cannot be cancelled."


==================================================
6. System Flow:
==================================================
Admin UI
   â†“
Agent Service (Planner â†’ Validator â†’ Executor â†’ Responder)
   â†“
Backend API (/api)
   â†“
JSON Storage

Every request has:
- traceId
- workflowId
- sessionId


==================================================
7. Customer View:
==================================================
- URL: http://localhost:3000/
- This is only read-only page
- Customer can view the products and order history
          - Read-only storefront for browsing products
- Included for realism and data generation


==================================================
8. Admin UI:
==================================================
- URL: http://localhost:3000/admin
- This is the admin page where admin can see the recent orders
           - Displays:
           - Recent orders
           - Product catalog
           - Allows:
               - Updating order status
               - Editing product details (name, description, price)
- You will extend this page by embedding a chatbot interface that allows an administrator to manage the store using natural language.


==================================================
9. Backend API:
==================================================
- Base URL: http://localhost:5000/api
- Full API documentation available at http://localhost:5000/api
- We can extend this API by keeping the "http://localhost:5000/api/v1/orders" where we can modify and basically interact with agents and modify the order details
- We can extend this API by keeping the products information on "http://localhost:5000/api/v1/products" on this endpoints basically what we do is we can change the product info through the agents
- Chat endpoint: http://localhost:5000/api/chat


==================================================
10. Model Selected:
==================================================
- Model: ollama pull qwen3-coder:30b
- Source: https://ollama.com/library/qwen3-coder:30b (19GB)
- I downloaded the latest AI qwen3:30b parameter model because it supports the thinking and coder activities and especially it is designed for agent workflows


==================================================
11. Traceability Model (Mandatory):
==================================================
Every request generates:
- traceId = uuid()
- workflowId = `SHOP-${Date.now()}`
- sessionId = browser session
- workflowTimestampStart = ISO timestamp when workflow begins
- workflowTimestampEnd = ISO timestamp when workflow completes

Propagated across:
UI â†’ Agent â†’ API â†’ Storage â†’ Logs

Audit Fields:
- userId (admin identifier)
- action (intent/operation performed)
- entityType (product, order, etc.)
- entityId (SKU, orderNumber, etc.)
- oldValue (before change)
- newValue (after change)
- status (success, failed, pending_confirmation)
- errorMessage (if failed)

Example Trace Log:
{
  "traceId": "t-91283",
  "workflowId": "SHOP-77822",
  "sessionId": "sess-abc123",
  "workflowTimestampStart": "2026-01-29T10:11:00.000Z",
  "workflowTimestampEnd": "2026-01-29T10:11:00.340Z",
  "agent": "ValidationAgent",
  "intent": "UPDATE_PRODUCT_PRICE",
  "userId": "admin",
  "action": "UPDATE_PRODUCT_PRICE",
  "entityType": "product",
  "entityId": "PD-1067",
  "sku": "PD-1067",
  "oldPrice": 890,
  "newPrice": 67,
  "oldValue": 890,
  "newValue": 67,
  "riskFlag": "PRICE_OUTLIER",
  "status": "pending_confirmation",
  "timestamp": "2026-01-29T10:11:00Z"
}


==================================================
12. Metrics - What to Capture and Where to Store:
==================================================
Where to Store Metrics:
For assignment:
- /metrics/metrics.json (append)
- Console logs

Optional bonus:
- SQLite

Workflow Metrics:
| Metric           | Example   |
| ---------------- | --------- |
| workflow_id      | SHOP-9912 |
| trace_id         | t-111     |
| total_latency_ms | 340       |
| success          | true      |
| retries          | 0         |
| agent_steps      | 4         |

LLM Metrics:
| Metric            | Example |
| ----------------- | ------- |
| prompt_tokens     | 412     |
| completion_tokens | 91      |
| context_usage_pct | 32%     |
| latency_ms        | 220     |
| retry_count       | 0       |

Agent Metrics:
| Metric                     | Example       |
| -------------------------- | ------------- |
| intent_confidence          | 0.94          |
| schema_validation_failures | 0             |
| guardrail_triggers         | PRICE_OUTLIER |
| tool_calls                 | 1             |

API Metrics:
| Metric         | Example |
| -------------- | ------- |
| api_latency_ms | 41      |
| file_write_ms  | 12      |
| errors         | 0       |

MetricsEvent Schema:
File: /metrics/metrics.jsonl   (append only)

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MetricsEvent",
  "type": "object",
  "required": [
    "traceId",
    "workflowId",
    "sessionId",
    "timestamp",
    "layer",
    "metrics"
  ],
  "properties": {
    "traceId": { "type": "string" },
    "workflowId": { "type": "string" },
    "sessionId": { "type": "string" },
    "timestamp": { "type": "string", "format": "date-time" },
    "layer": {
      "type": "string",
      "enum": ["WORKFLOW", "PLANNER_AGENT", "VALIDATION_AGENT", "EXECUTION_AGENT", "RESPONSE_AGENT", "LLM", "API"]
    },
    "metrics": {
      "type": "object",
      "properties": {
        "workflow": {
          "type": "object",
          "properties": {
            "workflow_id": { "type": "string" },
            "trace_id": { "type": "string" },
            "total_latency_ms": { "type": "number" },
            "success": { "type": "boolean" },
            "retries": { "type": "number" },
            "agent_steps": { "type": "number" },
            "workflowTimestampStart": { "type": "string", "format": "date-time" },
            "workflowTimestampEnd": { "type": "string", "format": "date-time" }
          }
        },
        "plannerAgent": {
          "type": "object",
          "properties": {
            "timestampStart": { "type": "string", "format": "date-time" },
            "timestampCompleted": { "type": "string", "format": "date-time" },
            "latency_ms": { "type": "number" },
            "intent": { "type": "string" },
            "intent_confidence": { "type": "number" },
            "entities_extracted": { "type": "number" },
            "llm_calls": { "type": "number" },
            "errors": { "type": "number" }
          }
        },
        "validationAgent": {
          "type": "object",
          "properties": {
            "timestampStart": { "type": "string", "format": "date-time" },
            "timestampCompleted": { "type": "string", "format": "date-time" },
            "latency_ms": { "type": "number" },
            "schema_validation_failures": { "type": "number" },
            "guardrail_triggers": { "type": "array", "items": { "type": "string" } },
            "risk_flags": { "type": "array", "items": { "type": "string" } },
            "validation_passed": { "type": "boolean" },
            "errors": { "type": "number" }
          }
        },
        "executionAgent": {
          "type": "object",
          "properties": {
            "timestampStart": { "type": "string", "format": "date-time" },
            "timestampCompleted": { "type": "string", "format": "date-time" },
            "latency_ms": { "type": "number" },
            "tool_calls": { "type": "number" },
            "api_calls": { "type": "number" },
            "api_success": { "type": "boolean" },
            "data_updated": { "type": "boolean" },
            "errors": { "type": "number" }
          }
        },
        "responseAgent": {
          "type": "object",
          "properties": {
            "timestampStart": { "type": "string", "format": "date-time" },
            "timestampCompleted": { "type": "string", "format": "date-time" },
            "latency_ms": { "type": "number" },
            "response_type": { "type": "string", "enum": ["success", "confirmation", "error"] },
            "message_length": { "type": "number" },
            "errors": { "type": "number" }
          }
        },
        "llm": {
          "type": "object",
          "properties": {
            "prompt_tokens": { "type": "number" },
            "completion_tokens": { "type": "number" },
            "total_tokens": { "type": "number" },
            "context_usage_pct": { "type": "number" },
            "latency_ms": { "type": "number" },
            "retry_count": { "type": "number" },
            "model": { "type": "string" }
          }
        },
        "api": {
          "type": "object",
          "properties": {
            "api_latency_ms": { "type": "number" },
            "file_write_ms": { "type": "number" },
            "endpoint": { "type": "string" },
            "method": { "type": "string" },
            "status_code": { "type": "number" },
            "errors": { "type": "number" }
          }
        }
      },
      "additionalProperties": false
    }
  }
}

Example Metrics Entries:

Workflow Metric:
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.340Z",
  "layer": "WORKFLOW",
  "metrics": {
    "workflow": {
      "workflow_id": "SHOP-7788",
      "trace_id": "t-101",
      "total_latency_ms": 340,
      "success": true,
      "retries": 0,
      "agent_steps": 4,
      "workflowTimestampStart": "2026-01-29T10:11:00.000Z",
      "workflowTimestampEnd": "2026-01-29T10:11:00.340Z"
    }
  }
}

PlannerAgent Metric:
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.045Z",
  "layer": "PLANNER_AGENT",
  "metrics": {
    "plannerAgent": {
      "timestampStart": "2026-01-29T10:11:00.000Z",
      "timestampCompleted": "2026-01-29T10:11:00.045Z",
      "latency_ms": 45,
      "intent": "UPDATE_PRODUCT_PRICE",
      "intent_confidence": 0.94,
      "entities_extracted": 2,
      "llm_calls": 1,
      "errors": 0
    },
    "llm": {
      "prompt_tokens": 412,
      "completion_tokens": 91,
      "total_tokens": 503,
      "context_usage_pct": 32,
      "latency_ms": 40,
      "retry_count": 0,
      "model": "qwen3-coder:30b"
    }
  }
}

ValidationAgent Metric:
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.120Z",
  "layer": "VALIDATION_AGENT",
  "metrics": {
    "validationAgent": {
      "timestampStart": "2026-01-29T10:11:00.045Z",
      "timestampCompleted": "2026-01-29T10:11:00.120Z",
      "latency_ms": 75,
      "schema_validation_failures": 0,
      "guardrail_triggers": ["PRICE_OUTLIER"],
      "risk_flags": ["PRICE_OUTLIER"],
      "validation_passed": false,
      "errors": 0
    }
  }
}

ExecutionAgent Metric:
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.280Z",
  "layer": "EXECUTION_AGENT",
  "metrics": {
    "executionAgent": {
      "timestampStart": "2026-01-29T10:11:00.120Z",
      "timestampCompleted": "2026-01-29T10:11:00.280Z",
      "latency_ms": 160,
      "tool_calls": 1,
      "api_calls": 1,
      "api_success": true,
      "data_updated": true,
      "errors": 0
    },
    "api": {
      "api_latency_ms": 41,
      "file_write_ms": 12,
      "endpoint": "/api/v1/products/HP-BLK-001/price",
      "method": "PUT",
      "status_code": 200,
      "errors": 0
    }
  }
}

ResponseAgent Metric:
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.340Z",
  "layer": "RESPONSE_AGENT",
  "metrics": {
    "responseAgent": {
      "timestampStart": "2026-01-29T10:11:00.280Z",
      "timestampCompleted": "2026-01-29T10:11:00.340Z",
      "latency_ms": 60,
      "response_type": "success",
      "message_length": 87,
      "errors": 0
    }
  }
}

LLM Metric (Standalone):
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.085Z",
  "layer": "LLM",
  "metrics": {
    "llm": {
      "prompt_tokens": 412,
      "completion_tokens": 91,
      "total_tokens": 503,
      "context_usage_pct": 32,
      "latency_ms": 220,
      "retry_count": 0,
      "model": "qwen3-coder:30b"
    }
  }
}

API Metric (Standalone):
{
  "traceId": "t-101",
  "workflowId": "SHOP-7788",
  "sessionId": "sess-abc123",
  "timestamp": "2026-01-29T10:11:00.161Z",
  "layer": "API",
  "metrics": {
    "api": {
      "api_latency_ms": 41,
      "file_write_ms": 12,
      "endpoint": "/api/v1/products/HP-BLK-001/price",
      "method": "PUT",
      "status_code": 200,
      "errors": 0
    }
  }
}


==================================================
13. Prompt Registry (Versioned):
==================================================
Create:
/prompts/
   planner.v1.txt
   planner.v2.txt

planner.v1 (Simple):
- Extract intent
- Extract entities
- JSON output only

planner.v2 (Improved):
Adds:
- Confidence score
- Ambiguity detection
- Missing field detection

Why Version Prompts:
- Reproducibility
- Rollback
- A/B testing
- Auditability

In code:
const ACTIVE_PROMPT = "planner.v2";


==================================================
14. Guardrails (Business + AI):
==================================================
Price Outlier Guardrail:
Rule:
If |newPrice - oldPrice| / oldPrice > 40% â†’ Require confirmation

Example:
Old price = 890
New price = 67
Deviation = 92%
â†’ BLOCK + Ask confirmation

Agent Response:
âš ï¸ This is a large price change (from $890 â†’ $67, 92% drop).

Please confirm:
"CONFIRM price change for PD-1067 to $67"

Product Guardrails:
| Rule                  | Action             |
| --------------------- | ------------------ |
| SKU not found         | Reject             |
| price < 0             | Reject             |
| price < costPrice     | Warn               |
| price deviation > 40% | Human confirmation |
| product inactive      | Reject             |
| Description length limit | Reject (if exceeds) |
| Status active only    | Reject (if inactive) |

Order Guardrails:
| Rule                      | Action |
| ------------------------- | ------ |
| Order not found           | Reject |
| Invalid status transition | Reject |
| Already shipped â†’ cancel  | Reject |

Valid Order Transitions:
- pending â†’ shipped
- pending â†’ cancelled
- shipped â†’ delivered

Cannot cancel shipped orders.

LLM Guardrails:
| Rule               | Action     |
| ------------------ | ---------- |
| JSON parse fails   | Retry once |
| Schema invalid     | Reject     |
| Hallucinated field | Reject     |


==================================================
15. Human-in-the-Loop Flow (Price Outlier):
==================================================
Guardrail Rule:
ABS(newPrice - oldPrice) / oldPrice > 40%

Example:
Old price = 890
New price = 67
Deviation = 92%  â†’ BLOCK

Flow:
User Request
   â†“
Planner extracts intent
   â†“
Validator detects PRICE_OUTLIER
   â†“
State saved with pendingConfirmation = true
   â†“
Agent responds:
   "Please confirm price change"
   â†“
User confirms:
   "CONFIRM price change for PD-1067 to $67"
   â†“
Agent loads state
   â†“
Executes update


==================================================
16. Possible Admin Questions (Based on Data):
==================================================
Products:
âœ” Change price
âœ” Update description
âœ” Show product info
âœ” Check inventory level
âœ” Check category
âœ” Show promotions applied

Orders:
âœ” Cancel order
âœ” Mark shipped
âœ” Show order details
âœ” Check shipment status
âœ” View line items

Promotions (Optional):
âœ” Activate promotion
âœ” Disable promotion
âœ” Check usage


==================================================
17. Success Paths:
==================================================
Example: Price Update (Normal):
Admin â†’ "Change price of HP-BLK-001 to $320"
Validation â†’ OK (within threshold)
Execution â†’ Update JSON
Response â†’ Success confirmation
Metrics â†’ Logged

Example: Cancel Order:
Admin â†’ "Cancel order ORD-1001"
Validation â†’ status = pending
Execution â†’ Update status
Response â†’ Success


==================================================
18. Failure Paths (Edge Cases):
==================================================
SKU Not Found:
"Change price of SKU-9999 to $50"
â†’ Product not found

Negative Price:
"Change price of SKU-001 to -10"
â†’ Validation error

Invalid Order Transition:
"Cancel shipped order ORD-2001"
â†’ Not allowed

Large Price Outlier (Human Confirmation):
"Change price of PD-1067 to $67"
â†’ Block + ask confirmation

LLM Output Invalid:
LLM call â†’ Schema invalid â†’ Retry once â†’
Fail â†’ Fallback response


==================================================
19. Edge Case Flow Matrix:
==================================================
1. Price Outlier (Human Loop):
Request â†’ Validator detects outlier â†’ Save state â†’
Ask confirmation â†’ Wait â†’ Confirm â†’ Execute

2. SKU Not Found:
Request â†’ Validator fails â†’ Error response â†’ END

3. Negative Price:
Request â†’ Validator fails â†’ Error response â†’ END

4. Order Already Shipped:
Request â†’ Validator fails â†’ Explain restriction â†’ END

5. LLM Output Invalid:
LLM call â†’ Schema invalid â†’ Retry once â†’
Fail â†’ Fallback response


==================================================
20. State Persistence Strategy:
==================================================
For assignment:
In-memory Map + JSON snapshot

Store:
- sessionId
- pendingConfirmation
- lastIntent
- pendingPayload

File: /state/workflow_state.json

WorkflowState Schema:
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "WorkflowState",
  "type": "object",
  "required": [
    "sessionId",
    "workflowId",
    "traceId",
    "status",
    "updatedAt"
  ],
  "properties": {
    "sessionId": { "type": "string" },
    "workflowId": { "type": "string" },
    "traceId": { "type": "string" },
    "status": {
      "type": "string",
      "enum": ["IDLE", "PENDING_CONFIRMATION", "EXECUTING", "COMPLETED", "FAILED"]
    },
    "pendingAction": {
      "type": ["object", "null"],
      "properties": {
        "intent": { "type": "string" },
        "entity": { "type": "object" },
        "riskFlag": { "type": "string" },
        "originalValue": { "type": "number" },
        "requestedValue": { "type": "number" }
      }
    },
    "conversationSummary": { "type": "string" },
    "metricsSnapshot": {
      "type": "object",
      "properties": {
        "llmTokens": { "type": "number" },
        "latencyMs": { "type": "number" }
      }
    },
    "updatedAt": { "type": "string", "format": "date-time" }
  }
}


==================================================
21. Workflow State Machine:
==================================================
IDLE
  â†“
EXECUTING
  â†“
PENDING_CONFIRMATION (optional)
  â†“
EXECUTING
  â†“
COMPLETED
  â†“
IDLE

Failure goes to:
FAILED â†’ IDLE


==================================================
22. Folder Additions:
==================================================
/metrics
/prompts
/state
/logs


==================================================
23. Development Phase Checklist:
==================================================
Phase 1 â€“ Infrastructure:
âœ… Agent service skeleton
âœ… State store module
âœ… Metrics logger
âœ… Trace ID middleware

Phase 2 â€“ Agent Core:
âœ… Planner prompt
âœ… Validation rules
âœ… Guardrail logic
âœ… Tool registry

Phase 3 â€“ Human Loop:
âœ… Pending state persistence
âœ… Confirmation detection
âœ… Resume execution

Phase 4 â€“ Observability:
âœ… Metrics append
âœ… Trace logs
âœ… Error logs

Phase 5 â€“ Tests:
âœ… Guardrail tests
âœ… Confirmation tests
âœ… API tests
